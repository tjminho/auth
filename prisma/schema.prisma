generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String          @id @default(uuid())
  name                   String?
  email                  String?         @unique // provider에서 받은 이메일 (인증 여부 불문)
  trustedEmail           String?         @unique // 인증 완료된 이메일만 저장
  emailVerified          DateTime? // trustedEmail 인증 완료 시각
  lastVerificationSentAt DateTime? // 마지막 인증 메일 발송 시각
  provider               String? // 최초 가입 시 사용한 provider
  password               String?         @db.VarChar(255)
  image                  String?
  unverified             Boolean         @default(false)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  role                   Role            @default(USER)
  status                 UserStatus      @default(ACTIVE)
  subscriptionExpiresAt  DateTime? // 구독 만료일 (SUBSCRIBER용)
  lastProvider           String? // 마지막 로그인에 사용된 provider
  mfaEnabled             Boolean         @default(false)
  mfaSecret              String?         @db.VarChar(255)
  mfaVerifiedAt          DateTime?
  deletedAt              DateTime? // soft-delete 용도
  fcmTokens              FcmToken[]
  accounts               Account[]
  sessions               Session[]
  verifiedEmails         VerifiedEmail[]
  companies              Company[]       @relation("UserCompanies")
  Company                Company[]
  loginHistory           LoginHistory[]

  @@unique([provider, email]) // provider+email 조합으로 unique
  @@index([status])
}

model Account {
  id                String   @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?  @db.Text
  refresh_token     String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model Verification {
  id         String           @id @default(uuid())
  identifier String           @db.VarChar(255) // 이메일 또는 사용자 ID
  userId     String
  value      String
  type       VerificationType
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime         @default(now())

  // consumedAt이 NULL일 때만 unique 보장 필요 → migration에서 partial index 고려
  @@index([identifier])
  @@index([value])
}

model VerifiedEmail {
  id         String   @id @default(uuid())
  email      String
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  verifiedAt DateTime @default(now())
  ipAddress  String?
  userAgent  String?

  @@unique([userId, email]) // 한 유저가 동일 이메일을 중복 인증 불가
  @@index([userId])
}

model Company {
  id        String   @id @default(uuid())
  name      String
  subdomain String   @unique
  adminId   String // User와 관계로 변경
  createdAt DateTime @default(now())
  createdBy String
  creator   User     @relation("UserCompanies", fields: [createdBy], references: [id])
  admin     User     @relation(fields: [adminId], references: [id])

  @@index([createdBy])
  @@index([adminId])
}

model VerificationSession {
  vid       String   @id
  userId    String // User.id 타입에 맞게 (Int라면 Int로)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LoginHistory {
  id        String   @id @default(uuid())
  userId    String
  provider  String
  ip        String
  userAgent String
  location  String? // GeoIP 결과
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model FcmToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime @default(now())
}

enum VerificationType {
  EMAIL
  PASSWORD_RESET
}

enum Role {
  USER // 기본 사용자
  SUBSCRIBER // 유료 구독자
  MODERATOR // 커뮤니티 관리자
  ADMIN // 시스템 관리자
  SUPER_ADMIN // 최고 관리자 (관리자 부여/회수 권한)
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
  PENDING
  BLOCKED // 관리자 차단
}
